/*! qinblog 1.0.0 | http://www.qinblog.net | (c) 2017 qinblog | MIT License */
;(function($){if(!window.jQuery){throw new Error("Comment : requires jQuery")}if(!window.UIkit){throw new Error("Comment : requires UIkit")}var commentOBJ={};var commentDialogOBJ={};var settings={};var commentList={OBJ:{},List:{}};$.extend({comment_message:function(msg,mode){$('body').append("<div class='submit_massage'>"+msg+"</div>");var submit_message=$('body').find('.submit_massage');submit_message.css({'position':'absolute','color':'#fff','padding':'10px','font-size':'18px','border':'1px solid #dadada','border-radius':'5px'});var top=($(window).height()-submit_message.height())/2;var left=($(window).width()-submit_message.width())/2;var scrollTop=$(document).scrollTop();var scrollLeft=$(document).scrollLeft();mode=='success'?submit_message.css({'background-color':'#16A085'}):submit_message.css({'background-color':'#c0392b'});submit_message.offset({top:top+scrollTop-30,left:left+scrollLeft});submit_message.fadeOut(1500,function(){submit_message.remove()})}});var user_info={img:'',name:'',uid:0,access_token:0};var LG_func={show_user:function(img,name){var logout_button='';if(WB2.checkLogin()){logout_button='<span class="logout-user" '+'onclick="WB2.logout(function() {window.location.reload();});">退出</span>'}else if(hello('github').getAuthResponse()){logout_button='<span class="logout-user" '+'onclick="hello(\'github\').logout().then(function() {window.location.reload();});">退出</span>'}else if(QC.Login.check()){logout_button='<span class="logout-user" '+'onclick="QC.Login.signOut();window.location.reload();">退出</span>'}commentDialogOBJ.find(".button-face").after('<span class="login-user">'+'<img src="'+img+'">'+name+'</span>'+logout_button)},get_user_info:function(){if(WB2.checkLogin()){return{access_token:user_info.access_token,uid:user_info.uid,img:user_info.img,name:user_info.name,api_from:'weibo'}}if(QC.Login.check()){return{access_token:user_info.access_token,uid:user_info.uid,img:user_info.img,name:user_info.name,api_from:'qq'}}if(hello('github').getAuthResponse()){return{access_token:user_info.access_token,uid:user_info.uid,img:user_info.img,name:user_info.name,api_from:'github'}}return false},login_vertify:function(){if(WB2.checkLogin()){WB2.anyWhere(function(W){W.parseCMD('/users/show.json',function(oResult,bStatus){if(bStatus){user_info.img=oResult.profile_image_url;user_info.name=oResult.screen_name;user_info.uid=WB2._config.uid;user_info.access_token=WB2._config.access_token;LG_func.show_user(user_info.img,user_info.name)}},{uid:WB2._config.uid},{method:'get',cache_time:30})});return true}if(QC.Login.check()){QC.api("get_user_info",{}).success(function(s){user_info.img=s.data.figureurl;user_info.name=s.data.nickname;LG_func.show_user(user_info.img,user_info.name)});QC.Login.getMe(function(openId,accessToken){user_info.uid=openId;user_info.access_token=accessToken});return true}var g_login_info=hello('github').getAuthResponse();if(g_login_info){hello('github').api('me').then(function(json){user_info.img=json.thumbnail;user_info.name=json.name;user_info.uid=json.id;user_info.access_token=g_login_info.access_token;LG_func.show_user(user_info.img,user_info.name)});return true}return false},login_weibo:function(){WB2.anyWhere(function(W){W.widget.connectButton({id:"wb_connect_btn",type:'3,2',callback:{login:function(o){window.location.reload()},logout:function(){window.location.reload()}}})})},login_qq:function(){QC.Login({btnId:"qqLoginBtn",size:"A_M"},function(reqData,opts){window.location.reload()},function(opts){window.location.reload()})},login_github:function(){$('#github_connect_btn').click(function(){var github=hello('github');github.login().then(function(){return github.api('me')}).then(function(p){window.location.reload()})})},login:function(){commentOBJ.attr('xmlns:wb','http://open.weibo.com/wb');if(!LG_func.login_vertify()){commentOBJ.append('<div id="login_window" class="uk-modal">'+'<div class="uk-modal-dialog"><a class="uk-modal-close uk-close"></a>'+'<h3>请先登陆哦</h3>'+'<div id="wb_connect_btn" style="margin-bottom:20px;"></div>'+'<span id="qqLoginBtn" style="display:block;margin-bottom:20px;"></span>'+'<img src="/Public/img/github_login.png" id="github_connect_btn" style="display:block;cursor:pointer;"></img>'+'</div></div>');commentOBJ.find('#comment_dialog, #comment_list').off('click','.button-submit');commentOBJ.on('focus','.comment-text',function(event){event.preventDefault();UIkit.modal("#login_window").show()});commentOBJ.on('click','.button-submit',function(event){event.preventDefault();UIkit.modal("#login_window").show()});LG_func.login_weibo();LG_func.login_qq();LG_func.login_github()}}};var CD_func={create_dialog:function(){var dialog='<div id="comment_dialog">'+'<div class="comment-text" contenteditable="true"></div>'+'<div class="comment-tool">'+'<span class="button-face"><i class="uk-icon uk-icon-smile-o"></i></span>'+'<span class="button-submit">提交</span></div></div>';commentOBJ.append(dialog);commentDialogOBJ=commentOBJ.find('#comment_dialog');CD_func.dialog_face.call(commentDialogOBJ,settings.img_url);CD_func.comment_submit.call(commentDialogOBJ,settings.submit_url)},reply_dialog:function(){var dialog='<div id="reply_dialog"><div class="comment-text" contenteditable="true"></div>'+'<div class="comment-tool">'+'<span class="button-face"><i class="uk-icon uk-icon-smile-o"></i></span>'+'<span class="button-submit">提交</span></div></div>';commentList.OBJ.append(dialog);CD_func.dialog_face.call(commentList.OBJ,settings.img_url);CD_func.comment_submit.call(commentList.OBJ,settings.submit_url)},dialog_face:function(img_url){var $this=this;jQuery.ajax({type:"GET",url:img_url+"/twemoji.json",dataType:"json",global:false,success:function(data){var facebox='<div class="facebox uk-panel uk-panel-box"><ul>';for(var v in data){facebox+='<li><img src="'+img_url+'/'+data[v]+'" title="'+v+'" width="22"></li>'}facebox+='</ul>';facebox+='<div style="clear:both;padding-top:5px;color:#888;font-weight:bold;">'+'<hr><span>Copyright 2016 Twitter, Inc and other contributors</span></div>';facebox+='</div>';$this.find('.comment-tool').append(facebox);var optOBJ={facebox:$this.find('.facebox'),text:$this.find(".comment-text"),};$this.on('click','.button-face',function(event){event.preventDefault();if(optOBJ.facebox.css('display')=='none'){optOBJ.facebox.slideDown()}optOBJ.text.focus()});$this.on('blur','.comment-text',function(event){event.preventDefault();optOBJ.facebox.slideUp()});$this.on('click','.facebox > ul > li',function(event){event.preventDefault();optOBJ.text.append($(this).find('img').clone());optOBJ.text.focus()});$this.on('click','.facebox',function(event){event.preventDefault();optOBJ.text.focus()});$this.on('mouseover','.facebox',function(event){event.preventDefault();$this.off('blur','.comment-text')});$this.on('mouseout','.facebox',function(event){event.preventDefault();$this.on('blur','.comment-text',function(event){event.preventDefault();optOBJ.facebox.slideUp()})})}})},comment_submit:function(submit_url){var $this=this;$this.on('click','.button-submit',function(event){event.preventDefault();var comment_text=$this.find('.comment-text');var comment_content=comment_text.html();comment_content=$.trim(comment_content.replace(/^(<div><br><\/div>)*(.*)(<div><br><\/div>)*$/,"$2"));if(comment_content==''){comment_text.focus();$.comment_message('请输入内容','error');return}if(comment_content.replace(/<[^>]*>/,'').length>255){comment_text.focus();$.comment_message('请输入小于255个字符','error');return}if($(this).closest('li').length!=0&&$(this).closest('li').children('ul').length==0){comment_content=comment_text.prev('lable').html()+' '+comment_content}var reply_comment_id=$(this).closest('.p_comment').attr('id');var pid=typeof(reply_comment_id)=='undefined'?0:reply_comment_id.substr(reply_comment_id.lastIndexOf('_')+1);var login_info=LG_func.get_user_info();if(login_info===false){$.comment_message('你还没登陆哦','error');return}$this.find('.button-submit').html('<i class="uk-icon-spin uk-icon-spinner" style="font-size:18px;float:right;"></i>');jQuery.ajax({type:"POST",url:submit_url,dataType:'json',data:{'pid':pid,'content':comment_content,'img':login_info.img,'name':login_info.name,'uid':login_info.uid,'access_token':login_info.access_token,'api_from':login_info.api_from},success:function(data){$this.find('.button-submit').html('提交');if(data.status==0){$.comment_message(data.msg,'error');return}$.comment_message('提交成功','success');comment_text.empty();CL_func.comment_create(data,'refresh');commentOBJ.find('#no_comment').remove();if(pid!=0){$this.find('#reply_dialog').slideUp();var reply_count=$this.find('.reply-count');reply_count.each(function(){$(this).html($(this).closest('li').children('ul').children('li').length)})}var comment_count=commentOBJ.find('#comment_count');comment_count.html(parseInt(comment_count.html())+1)}})})}};var CL_func={comment_load:function(comment_url,callback){commentOBJ.append('<div id="comment_load" style="text-align:center;font-size:24px;opacity:0.8;"><br><br>'+'<i class="uk-icon-spin uk-icon-spinner"></i> 条目读取中...<br></div>');jQuery.ajax({type:"GET",url:comment_url+'?rd_'+Math.random(),dataType:"json",global:false,success:function(data){commentOBJ.find('#comment_load').remove();commentOBJ.append('<div id="comment_list"><br><hr><h3 class="uk-h2">评论（<span id="comment_count">'+data.length+'</span>）'+'<div id="comment_sort" class="uk-align-right">'+'<span id="sort_new" class="uk-margin-right">最新</span>'+'<span id="sort_comment" class="uk-margin-right">评论最多</span>'+'<span id="sort_like" class="uk-margin-right">点赞最多</span></div></h3>'+'<ul id="comment_list_ul" class="uk-comment-list">');commentList.OBJ=commentOBJ.find('#comment_list');commentList.List=commentList.OBJ.find('#comment_list_ul');if(data.length==0){commentOBJ.append('<div id="no_comment" style="text-align:center;font-size:18px;opacity:0.8;">'+'<br><br><i class="uk-icon uk-icon-commenting-o"></i> '+'还没有评论呦~ 说点什么吧<br><br></div>')}for(var i=0;i<data.length;i++){CL_func.comment_create(data[i],'load')}commentOBJ.append('</ul></div>');CD_func.reply_dialog();var reply_button={};commentList.OBJ.on('click','.reply',function(event){event.preventDefault();var replyOBJ=commentList.OBJ.find('#reply_dialog');replyOBJ.slideDown();replyOBJ.appendTo($(this).closest('article'));var reply_lable='<lable style="color:#888;padding-right:10px;">回复 '+replyOBJ.parent().find('#username').focus().html()+':</lable>';replyOBJ.find('.comment-text').prev('lable').remove();replyOBJ.find('.comment-text').before(reply_lable).focus();if(reply_button==this){replyOBJ.slideUp();reply_button={}}else{reply_button=this}});var reply_count=commentList.OBJ.find('.reply-count');reply_count.each(function(){$(this).html($(this).closest('li').find('ul').find('li').length)});commentList.OBJ.on('click','.reply-list',function(event){event.preventDefault();var reply_list=$(this).closest('li').children('ul');if(reply_list.find('li').length!=0){if(reply_list.css('display')=='none'){$(this).html('<i class="uk-icon uk-icon-comments"></i> 收起回复')}else{$(this).html('<i class="uk-icon uk-icon-list-ul"></i> 展开回复')}reply_list.slideToggle(500)}});commentList.OBJ.on('click','.like',function(event){event.preventDefault();var comment_id=$(this).closest('li').attr('id');methods.comment_like.call($(this),settings.like_url,comment_id.substr(comment_id.lastIndexOf('_')+1))});function sort_callback(mode){var top_comment=commentList.OBJ.children('ul').children('li');var comment_list_sorted=CL_func.comment_sort(top_comment,mode);commentList.List.empty().append(comment_list_sorted);CL_func.comment_page(comment_list_sorted)}commentList.OBJ.find('#sort_new').click(function(){sort_callback('new')});commentList.OBJ.find('#sort_comment').click(function(){sort_callback('comment')});commentList.OBJ.find('#sort_like').click(function(){sort_callback('like')});var top_comment=commentList.OBJ.children('ul').children('li');CL_func.comment_page(top_comment);if(typeof(callback)=='function'){callback()}}})},comment_create:function(data,type){var date=new Date(parseInt(data.timestamp)*1000);if(data.pid==0){var element='<li id="comment_id_'+data.id+'" class="p_comment"><article class="uk-comment">'+'<header class="uk-comment-header">'+'<img class="uk-comment-avatar" width="50" height="50" src="'+data.img_url+'" alt="">'+'<h4 id="username" class="uk-comment-title">'+data.username+'</h4>'+'<div class="uk-comment-body">'+data.content+'</div>'+'<p class="uk-comment-meta uk-align-right uk-margin-top">'+'<span id="comment_date" class="uk-margin-right">'+date.getFullYear()+'/'+(date.getMonth()+1)+'/'+date.getDate()+' '+date.getHours()+':'+date.getMinutes()+':'+date.getSeconds()+'</span><span class="uk-margin-right reply">'+'<i class="uk-icon uk-icon-reply"></i> 回复</span><span class="reply-list">'+'<i class="uk-icon uk-icon-comments"></i> 收起回复</span>'+'(<span class="reply-count">0</span>) <span class="like">'+'<i class="uk-icon uk-icon-heart-o"></i> 赞</span>(<span class="like-count">'+data.like_count+'</span>) '+'</p></header></article><ul></ul></li>';if(type=='load'){commentList.List.append(element)}else if(type=='refresh'){commentList.List.prepend(element)}else{$.error('[comment]comment_create : unkonw mode "'+type+'" !')}}else{var element='<li id="comment_id_'+data.id+'" class="c_comment"><article class="uk-comment">'+'<header class="uk-comment-header">'+'<img class="uk-comment-avatar" width="50" height="50" src="'+data.img_url+'" alt="">'+'<h4 id="username" class="uk-comment-title">'+data.username+'</h4>'+'<div class="uk-comment-body">'+data.content+'</div>'+'<p class="uk-comment-meta uk-align-right uk-margin-top">'+'<span id="comment_date" class="uk-margin-right">'+date.getFullYear()+'/'+(date.getMonth()+1)+'/'+date.getDate()+' '+date.getHours()+':'+date.getMinutes()+':'+date.getSeconds()+'</span><span class="uk-margin-right reply">'+'<i class="uk-icon uk-icon-reply"></i> 回复</span><span class="like">'+'<i class="uk-icon uk-icon-heart-o"></i> 赞</span>(<span class="like-count">'+data.like_count+'</span>) '+'</p></header></article></li>';var parent_OBJ=commentList.List.find('#comment_id_'+data.pid);if(parent_OBJ.children('ul').length==0){if(type=='load'){parent_OBJ.closest('ul').prepend(element)}else if(type=='refresh'){parent_OBJ.closest('ul').append(element)}else{$.error('[comment]comment_create : unkonw mode "'+type+'" !')}}else{if(type=='load'){parent_OBJ.children('ul').prepend(element)}else if(type=='refresh'){parent_OBJ.children('ul').append(element)}else{$.error('[comment]comment_create : unkonw mode "'+type+'" !')}}}},comment_sort:function(arr,mode){arr.sort(function(a,b){if(mode=='new'){var countA=Date.parse(new Date($(a).find('#comment_date').html()));var countB=Date.parse(new Date($(b).find('#comment_date').html()))}else if(mode=='comment'){var countA=$(a).find('.reply-count').html();var countB=$(b).find('.reply-count').html()}else if(mode=='like'){var countA=$(a).find('.like-count').html();var countB=$(b).find('.like-count').html()}else{$.error('comment: unkonw sort mode "'+mode+'" !')}return(parseInt(countA)<parseInt(countB))?1:-1});return arr},comment_page:function(arr){var page_size=10;var offset=0;var item=arr.length-1;var total=Math.ceil(item/page_size);if(total<=1){return}for(var i=0;i<=item;i++){if(i>=page_size){$(arr[i]).hide()}else{$(arr[i]).show()}}var comment_page=commentList.OBJ.find('#comment_page');if(comment_page.length!=0){comment_page.remove()}var page_content='<div id="comment_page"><ul class="uk-pagination uk-pagination-right"></ul></div>';commentList.OBJ.append(page_content);UIkit.pagination('.uk-pagination',{items:item,itemsOnPage:page_size,currentPage:0,onSelectPage:function(pageIndex){window.location.href="#comment_list";for(var i=0;i<=item;i++){if(i<(pageIndex*page_size)||i>=(pageIndex*page_size+page_size)){$(arr[i]).hide()}else{$(arr[i]).show()}}}})}};var methods={init:function(options,callback){commentOBJ=this;var defaults={comment_url:'comment.json',img_url:'./img/twemoji',like_url:'like.php',submit_url:'comment.php'};settings=$.extend({},defaults,options);CD_func.create_dialog();CL_func.comment_load(settings.comment_url,function(){LG_func.login()});if(typeof(callback)=='function'){callback()}return this;},comment_like:function(like_url,id){var $this=this;jQuery.ajax({type:"get",url:like_url+'/'+id,dataType:"json",global:false,success:function(data){if(data.status==0){$.comment_message(data.msg,'error');return}var like_count=$this.next('.like-count');like_count.html(parseInt(like_count.html())+1);$this.find('i').removeClass('uk-icon-heart-o').addClass('uk-icon-heart');$this.removeClass('like');$this.append('<div class="like_plus">+1</div>');var like_plus=$this.find('.like_plus');like_plus.offset({top:$this.offset().top-1.5*$this.height(),left:$this.offset().left+$this.width()});like_plus.animate({fontSize:"18px"}).fadeOut('500',function(){like_plus.remove()})}});return this}};$.fn.comment=function(){var method=arguments[0];if(methods[method]){method=methods[method];arguments=Array.prototype.slice.call(arguments,1)}else if(typeof(method)=='object'||!method){method=methods.init}else{$.error('Method '+method+' does not exist on jQuery.pluginName');return this}return method.apply(this,arguments);}})(jQuery);